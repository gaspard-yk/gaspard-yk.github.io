<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Test Telegram WebApps API</title>
	<link href="style.css" rel="stylesheet" type="text/css">
</head>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!--Подключаем скрипт от телеграм-->


<body>

	<header>
		<h1>Cart for Telegram </h1>
	</header>


	<script>

		function page2(type) {
			
			// document.getElementById('page1').style.display='none';
			if (type == 'ofd') {
				if (document.getElementById('ofd').getAttribute('open')=='false')// getComputedStyle(document.getElementById('ofd-type')).display == 'none') 
					{
					document.getElementById('ofd-type').style.display = 'inline-flex';
					document.getElementById('ofd').innerHTML = 'Подписки ОФД: &#8657';
					document.getElementById('ofd').setAttribute('open','true')
				} 
				else {
					document.getElementById('ofd-type').style.display = 'none';
					document.getElementById('ofd').innerHTML = 'Подписки ОФД: &#8659';
					document.getElementById('ofd').setAttribute('open','false')
				}
				// document.getElementById('types').innerText='ofd types';
				// let div = document.createElement('div')
				// document.body.append(div);
			} else {
				if (document.getElementById('another').getAttribute('open')=='false') {//getComputedStyle(document.getElementById('another-type')).display == 'none'
					document.getElementById('another-type').style.display = 'inline-flex';
					document.getElementById('another').innerHTML = 'Иные подписки: &#8657';
					document.getElementById('another').setAttribute('open','true')
				} else {
					document.getElementById('another-type').style.display = 'none';
					document.getElementById('another').innerHTML = 'Иные подписки: &#8659';
					document.getElementById('another').setAttribute('open','false')
				}

				// let div = document.createElement('div')
				// document.body.append(div);
			}
		}
	</script>

	<ul id="page1">
		<li>
			<button onclick="page2('ofd')" id="ofd" open=false class="btn">Подписки ОФД: &#8659</button>
		</li>
		<li>
			<div id="ofd-type"></div>
		</li>
		<li>
			<button onclick="page2()" id="another" open=false class="btn">Иные подписки: &#8659</button>
		</li>
		<li>
			<div id="another-type"></div>
		</li>
	</ul>
	</footer>

	<script>
      window.cart={};
		range=[{
            id:'ofd1',
            name:'ofd1',
            count:10,
            cost:110.5,
            },
            {
            id:'ofd2',
            name:'ofd2',
            count:22,
            cost:30.3,
            },
				{
            id:'ofd1',
            name:'ofd1',
            count:10,
            cost:110.5,
            },
				{
            id:'ofd1',
            name:'ofd1',
            count:10,
            cost:110.5,
            },
				{
            id:'ofd1',
            name:'ofd1',
            count:10,
            cost:110.5,
            },
            {
            id:'ofd2',
            name:'ofd2',
            count:22,
            cost:30.3,
            },
				{
            id:'ofd1',
            name:'ofd1',
            count:10,
            cost:110.5,
            },
				{
            id:'ofd1',
            name:'ofd1',
            count:10,
            cost:110.5,
            }]
		for (let i in range) {
			let div = document.createElement('div');
			div.setAttribute('class', 'product')

			let image = document.createElement('img');
			image.src = `img/tt.jpg`
			image.setAttribute('class', 'product_img')
			// image.src = `data:image/png;base64,${range[i]['image']}`
			// image.setAttribute('width',300)
			// image.setAttribute('height',300)
			div.appendChild(image);


			let title = document.createElement('p'); //создаем еще параграф 
			title.innerText = `${range[i]['name']}`;
			title.setAttribute('class', 'product_title')
			div.appendChild(title); //добавляем 

			let count = document.createElement('p'); //count -> rest
			count.innerText = `В наличии ${range[i]['count']} шт.`;
			count.setAttribute('class','product_count')
			div.appendChild(count); //добавляем 

			let price = document.createElement('p'); //создаем еще параграф 
			price.innerText = `Цена = ${range[i]['cost']}`;
			price.setAttribute('class','product_price')
			div.appendChild(price); //добавляем 

			let plus = document.createElement('input'); //создаем кнопку
			plus.type = 'button';
			plus.setAttribute('class', 'plus product_btn')
			plus.setAttribute('value', '+')
			plus.setAttribute('id', `${range[i]['id']}`)
			//plus.id=`${range[i]['code']}`;//можно повесить обработку для каждой кнопки индивидуально здгы.onclick = function minusFunction(){}
			// minus.onclick = plusFunction(minus.id);
         div.appendChild(plus); //добавляем 

			let minus = document.createElement('input'); //создаем кнопку
			minus.type = 'button';
			minus.setAttribute('class', 'minus product_btn')
			minus.setAttribute('value', '-')
			minus.setAttribute('id', `${range[i]['id']}`)
			//minus.id=`${range[i]['code']}`;//можно повесить обработку для каждой кнопки индивидуально здгы.onclick = function minusFunction(){}
			// minus.onclick = minusFunction(minus.id);
			div.appendChild(minus);

			let quantity = document.createElement('input');
			quantity.type = 'number';
			quantity.setAttribute('class', 'inputbox')
			quantity.setAttribute('value', '0')
			quantity.setAttribute('id', `c${range[i]['id']}`)
			quantity.setAttribute('name', 'quantity')
			quantity.setAttribute('readonly', true)
			// quantity.setAttribute('style', "width: 25px")
			div.appendChild(quantity);
			document.getElementById('ofd-type').appendChild(div)
			// document.body.append(div);

			range[range[i]['id']] = {
				name: range[i]['name'],
				cost: range[i]['cost'],
				count: range[i]['count'],
			}; //count->resr
			// delete range[i];
		}

         //увеличение количества товар
         const plusFunction =id=>{
         if(range[id]['count'] == 0){
               return }
         if((id in cart) === false){
            cart[id] = {name:range[id]['name'],
                     cost:range[id]['cost'],
                     count:0}
            cart[id]['count']=1;
         }
         else{
            if(cart[id]['count'] == range[id]['count'] ){
               return }
            cart[id]['count']++;
         }
         var qty_el = document.getElementById('c'+id); var qty = qty_el.value; if( !isNaN( qty )) qty_el.value++;return false;
      }


      // уменьшение количества товара
      const minusFunction =id=>{
         if ((id in cart) === false){
            return true;
         }
         else if (cart[id]['count']-1==0){
               deleteFunctiom(id);
               return true;
            }
         
         cart[id]['count']--;
         var qty_el = document.getElementById('c'+id); var qty = qty_el.value; if( !isNaN( qty )) qty_el.value--;return false;
      }


      // удаление товара
      const deleteFunctiom = id=>{
         delete cart[id];
         var qty_el = document.getElementById('c'+id); var qty = qty_el.value; if( !isNaN( qty )) qty_el.value=0;return false;
      }


      // //вывести содержимое корзины 
      // const showCartFunction=cart=>{

      // if(Object.keys(cart).length==0){
      //    return;
      // }
      // else{
      // let sumprice=0;
      // let cartstring="";
      // for(let id in cart){
      //    sumprice = sumprice+cart[id]['count']*cart[id]['cost'];
      //    cartstring=cartstring+"\n name "+ cart[id]['name']+" count "+cart[id]['count']+ " cost "+cart[id]['cost'];
      // }
      // alert("sum = "+sumprice + "\n"+ cartstring);
      // }
      // }


      document.onclick = event=>{
         if(event.target.classList.contains('plus')){
            plusFunction(event.target.id);
            console.log(cart)
         }
         if(event.target.classList.contains('minus')){
            minusFunction(event.target.id);
            console.log(cart)
         }
         if(event.target.classList.contains('show')){
         showCartFunction(cart);
         }
      }





		let tg = window.Telegram.WebApp; //получаем объект webapp телеграма 
		tg.expand(); //расширяем на все окно
		tg.MainButton.text = "Купить"; //изменяем текст кнопки
		tg.MainButton.textColor = "#F55353"; //изменяем цвет текста кнопки
		tg.MainButton.show()
		Telegram.WebApp.onEvent('mainButtonClicked', function() {
			if (Object.keys(window.cart).length == 0) {
				return;
			}
			// let sumprice = 0;
			// let cartstring = "";
			// for (let id in cart) {
			// 	sumprice = sumprice + cart[id]['count'] * cart[id]['cost'];
			// 	cartstring = cartstring + "\n name " + cart[id]['name'] + " count " + cart[id]['count'] + " cost " + cart[id]['cost'];
			// }
			arr=[];
			i=0;
			for(var key in cart){
				arr.push({})
				arr[i].code=key;
				arr[i].name=cart[key]['name'];
				arr[i].cost=cart[key]['cost'];
				arr[i].count=cart[key]['count'];
				i++;
			}
			itn = prompt('Введите ИНН','Ваш ИНН');

			if(/[0-9]/.test(itn) && itn.length==6){
				arr[i]=itn;
			}
			else{
				arr[i]=null;
			}
			//document.getElementById('').value;//itn input!!!!!!!!
				send = JSON.stringify(arr)
				tg.sendData(send); //при клике на основную кнопку отправляем данные в строковом виде}
		});
	</script>

</body>

</html>


